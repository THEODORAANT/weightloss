<perch:form id="questionnaire" method="POST" app="perch_forms" action="/client/questionnaire-re-order" data-questionnaire-form data-current-step="<perch:forms id="questionnaire_current_step" encode="attr" />" data-default-step="<perch:forms id="questionnaire_default_step" encode="attr" />" data-final-step="cart">

    <perch:if id="step" match="within" value="weight">
        <section class="how_old">
            <div class="contanier">
                <div class="what_Is_your">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                    <h2 class="js-question-label-weight">What is your current weight?</h2>
                    <div class="weight-inputs">
                        <input type="text" id="weight"  required name="weight" placeholder="Kg">
                        <input type="hidden" id="weight2"  required name="weight2" placeholder="lbs">
                        <input type="hidden" id="weightunit" value="kg"   name="weightunit" >


                    </div>
                    <div class="unit-selector unit_selector">
                        <label><input type="radio" required onchange="radioweight(this.value)" name="weightradio-unit" id="weightradio-kg" value="kg" checked >kg</label>
                        <label><input type="radio" onchange="radioweight(this.value)" name="weightradio-unit"  id="weightradio-lbs" value="st-lbs"> st/lbs</label>
                    </div>
                    <div class="buttons">
                        <input type="hidden" id="nextstep" name="nextstep" value="side-effects">
                        <button class="back"><a href="/client/re-order" style="text-decoration: none;color: #000;" >Back</a></button>
                        <button onclick="submitForm('weight')"   class="next"><span style="text-decoration: none;color: #000;" >Next →</span></button>
                    </div>
                </div>

            </div>

        </section>
        <script>


            function radioweight(value) {

                const weight = document.getElementById("weight");

                document.getElementById("weightunit").value = value;
                if (value === "kg") {
                    weight.placeholder = "Kg";
                    document.getElementById("weight2").type = "hidden";
                } else {
                    document.getElementById("weight2").type = "text";
                    weight.placeholder = "st";

                }


            }


        </script>
    </perch:if>
    <perch:if id="step" value="side-effects">
        <section class="how_old">
            <div class="contanier">
                <div class="are_you">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                    <div class="old_title">
                        <h2 class="js-question-label-side_effects">Have you experienced any side effects whilst taking the medication? </h2>
                    </div>


                    <div class="unde">

                        <div class="button-group">
                            <button id="yesBtn" onclick="setValuesreorderForm('side_effects','yes')"  class="custom_btn"><span data-question-option-key="side_effects" data-question-option-value="yes" style="text-decoration: none; color: #000;" >Yes</span></button>
                            <button id="noBtn" onclick="setValuesreorderForm('side_effects','no')"  class="custom_btn"><span data-question-option-key="side_effects" data-question-option-value="no" style="text-decoration: none; color: #000;" >No</span></button>
                            <input type="hidden" id="nextstep" name="nextstep" value="more_side_effects">
                            <input type="hidden" id="side_effects" name="more_side_effects" value="">


                        </div>

                    </div>
                    <div class="get_started">
                        <div class="started_button">
                            <div class="get_btn">
                                <button><a href="/client/questionnaire-re-order?step=weight">Back</a></button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </perch:if>
    <perch:if id="step" value="more_side_effects" >

        <section class="how_old ">
            <div class="mixed">
                <div class="bar">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                </div>
                <form id="ethnicityForm">
                    <label for="more_side_effects" class="js-question-label-more_side_effects">Please tell us as much as you can about your side effects - the type, duration, severity and whether they have resolved.</label>
                    <textarea id="more_side_effects" required name="more_side_effects" placeholder=""></textarea>
                    <p id="error-message" class="error-message">Please provide an answer before continuing.</p>
                    <div class="buttons">
                        <button type="button" class="back"><a style="text-decoration: none;
                                    color: #000;" href="/client/questionnaire-re-order?step=side_effects">Back</a></button>
                        <input type="hidden" id="nextstep" name="nextstep" value="additional-medication">
                        <button type="submit"  onclick="submitForm('more_side_effects')"  class="next"><span style="text-decoration: none; color: #000;" >Next →</span></button>

                    </div>
                </form>
            </div>
        </section>



    </perch:if>

    <perch:if id="step" value="additional-medication">
        <section class="how_old">
            <div class="contanier">
                <div class="are_you">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                    <div class="old_title">
                        <h2 class="js-question-label-additional_medication">Have you started taking any additional medication? </h2>
                    </div>


                    <div class="unde">

                        <div class="button-group">
                            <button id="yesBtn" onclick="setValuesreorderForm('additional-medication','yes')"  class="custom_btn"><span data-question-option-key="additional_medication" data-question-option-value="yes" style="text-decoration: none; color: #000;" >Yes</span></button>
                            <button id="noBtn" onclick="setValuesreorderForm('additional-medication','no')"  class="custom_btn"><span data-question-option-key="additional_medication" data-question-option-value="no" style="text-decoration: none; color: #000;" >No</span></button>
                            <input type="hidden" id="nextstep" name="nextstep" value="list_additional_medication">
                            <input type="hidden" id="additional-medication" name="additional-medication" value="">


                        </div>

                    </div>
                    <div class="get_started">
                        <div class="started_button">
                            <div class="get_btn">
                                <button><a href="/client/questionnaire-re-order?step=side-effects">Back</a></button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </perch:if>
    <perch:if id="step" value="list_additional_medication" >

        <section class="how_old ">
            <div class="mixed">
                <div class="bar">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                </div>
                <form id="ethnicityForm">
                    <label for="list_additional_medication" class="js-question-label-list_additional_medication">Please tell us as much as you can about your side effects - the type, duration, severity and whether they have resolved.</label>
                    <textarea id="list_additional_medication" required name="list_additional_medication" placeholder=""></textarea>
                    <p id="error-message" class="error-message">Please provide an answer before continuing.</p>
                    <div class="buttons">
                        <button type="button" class="back"><a style="text-decoration: none;
                                    color: #000;" href="/client/reorder-questionnaire?step=effects_with_wegovy">Back</a></button>
                        <input type="hidden" id="nextstep" name="nextstep" value="rate_current_experience">
                        <button type="submit"  onclick="submitForm('list_additional_medication')"  class="next"><span style="text-decoration: none; color: #000;" >Next →</span></button>

                    </div>
                </form>
            </div>
        </section>



    </perch:if>

    <perch:if id="step" value="rate_current_experience">
        <section class="how_old">
            <div class="contanier">
                <div class="are_you">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                    <div class="old_title">
                        <h2 class="js-question-label-rate_current_experience">Are you happy with your monthly weight loss?</h2>
                    </div>


                    <div class="unde">

                        <div class="button-group">
                            <button id="yesBtn" onclick="setValuesreorderForm('rate_current_experience','yes')"  class="custom_btn"><span data-question-option-key="rate_current_experience" data-question-option-value="yes" style="text-decoration: none; color: #000;" >Yes</span></button>
                            <button id="noBtn" onclick="setValuesreorderForm('rate_current_experience','no')"  class="custom_btn"><span data-question-option-key="rate_current_experience" data-question-option-value="no" style="text-decoration: none; color: #000;" >No</span></button>
                            <input type="hidden" id="nextstep" name="nextstep" value="contact">
                            <input type="hidden" id="rate_current_experience" name="rate_current_experience" value="">


                        </div>

                    </div>
                    <div class="get_started">
                        <div class="started_button">
                            <div class="get_btn">
                                <button><a href="/client/questionnaire-re-order?step=rate_current_experience">Back</a></button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </perch:if>
    <perch:if id="step" value="no-happy" >

        <section class="how_old ">
            <div class="mixed">
                <div class="bar">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                </div>
                <form id="ethnicityForm">
                    <label for="no_happy_reasons" class="js-question-label-no_happy_reasons">Please tell us as much as you can about the reasons you are not happy with your monthly weight loss.</label>
                    <textarea id="no_happy_reasons" required name="no_happy_reasons" placeholder=""></textarea>
                    <p id="error-message" class="error-message">Please provide an answer before continuing.</p>
                    <div class="buttons">
                        <button type="button" class="back"><a style="text-decoration: none;
                                    color: #000;" href="/client/questionnaire-re-order?step=rate_current_experience">Back</a></button>
                        <input type="hidden" id="nextstep" name="nextstep" value="contact">
                        <button type="submit"  onclick="submitForm('no_happy_reasons')"  class="next"><span style="text-decoration: none; color: #000;" >Next →</span></button>

                    </div>
                </form>
            </div>
        </section>



    </perch:if>


    <perch:if id="step" value="chat_with_us">
        <section class="how_old">
            <div class="contanier">
                <div class="are_you">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                    <div class="old_title">
                        <h2 class="js-question-label-chat_with_us">Would you like to chat with someone?</h2>
                    </div>


                    <div class="unde">

                        <div class="button-group">
                            <button id="yesBtn" onclick="setValuesreorderForm('chat_with_us','yes')"  class="custom_btn"><span data-question-option-key="chat_with_us" data-question-option-value="yes" style="text-decoration: none; color: #000;" >Yes</span></button>
                            <button id="noBtn" onclick="setValuesreorderForm('chat_with_us','no')"  class="custom_btn"><span data-question-option-key="chat_with_us" data-question-option-value="no" style="text-decoration: none; color: #000;" >No</span></button>
                            <input type="hidden" id="nextstep" name="nextstep" value="contact">
                            <input type="hidden" id="chat_with_us" name="chat_with_us" value="">


                        </div>

                    </div>
                    <div class="get_started">
                        <div class="started_button">
                            <div class="get_btn">
                                <button><a href="/client/questionnaire-re-order?step=rate_current_experience">Back</a></button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </perch:if>

    <perch:if id="step" value="contact" >

        <section class="how_old ">
            <div class="mixed">
                <div class="bar">
                    <!--  <div class="progress_bar">
                      <div class="nambar">
                          <span>22%</span>
                      </div>

                  </div>-->
                </div>
                <h2 class="js-question-label-email_address">Please enter your  email address</h2>
                <div class="weight-inputs">
                    <input type="text" id="email_address"  name="email_address" placeholder="e-mail address" style="width: 100%;" >

                    <input type="hidden" id="nextstep" name="nextstep" value="cart">

                </div>


                <div class="buttons skip ">
                    <button class="back skip_button "><a href="/order/cart" style="text-decoration: none;color: #000;" >Skip</a></button>
                </div>


                <div class="buttons">
                    <button class="back"><a href="/client/questionnaire-re-order?step=chat_with_us" style="text-decoration: none;color: #000;" >Back</a></button>
                    <button onclick="submitForm('email_address')" class="next"><span style="text-decoration: none;color: #000;" >Next →</span></button>
                </div>
            </div>
        </section>



    </perch:if>

    <script type="application/json" class="js-questionnaire-structure"><perch:forms id="questionnaire_structure_json" encode="false" /></script>
    <perch:if exists="questionnaire_dependencies_json">
        <script type="application/json" class="js-questionnaire-dependencies"><perch:forms id="questionnaire_dependencies_json" encode="false" /></script>
    </perch:if>
    <perch:if exists="questionnaire_steps_json">
        <script type="application/json" class="js-questionnaire-steps"><perch:forms id="questionnaire_steps_json" encode="false" /></script>
    </perch:if>
    <perch:if exists="questionnaire_answers_json">
        <script type="application/json" class="js-questionnaire-answers"><perch:forms id="questionnaire_answers_json" encode="false" /></script>
    </perch:if>
    <script>
        (function () {
            var form = document.querySelector('[data-questionnaire-form]');
            if (!form) {
                return;
            }

            var structureScript = form.querySelector('.js-questionnaire-structure');
            if (!structureScript) {
                return;
            }

            function parseJSON(el) {
                if (!el) {
                    return null;
                }
                try {
                    return JSON.parse(el.textContent || el.innerText || 'null');
                } catch (e) {
                    return null;
                }
            }

            function slugify(value) {
                return (value || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
            }

            function cssEscape(value) {
                return (value || '').toString().replace(/\\/g, '\\\\').replace(/"/g, '\\"');
            }

            function normalizeValues(values) {
                var list = Array.isArray(values) ? values : [values];
                var normalized = [];

                for (var i = 0; i < list.length; i++) {
                    var item = list[i];
                    if (item === null || typeof item === 'undefined') {
                        continue;
                    }

                    if (Array.isArray(item)) {
                        normalized = normalized.concat(normalizeValues(item));
                        continue;
                    }

                    var str = String(item);
                    var trimmed = str.trim();

                    if (trimmed === '') {
                        normalized.push('');
                    } else {
                        normalized.push(trimmed.toLowerCase());
                    }
                }

                return normalized;
            }

            function hasIntersection(valuesA, valuesB) {
                if (!valuesA.length || !valuesB.length) {
                    return false;
                }

                for (var i = 0; i < valuesA.length; i++) {
                    if (valuesB.indexOf(valuesA[i]) !== -1) {
                        return true;
                    }
                }

                return false;
            }

            function hasUsableValue(value) {
                if (value === null || typeof value === 'undefined') {
                    return false;
                }

                if (Array.isArray(value)) {
                    return value.length > 0;
                }

                if (typeof value === 'string') {
                    return value.trim() !== '';
                }

                return true;
            }

            function collectSelectorNames(questionKey, question) {
                var names = [];
                var seen = {};

                function addName(name) {
                    if (!name || seen[name]) {
                        return;
                    }
                    seen[name] = true;
                    names.push(name);
                }

                if (question && question.name) {
                    addName(question.name);
                    if (question.name.slice(-2) === '[]') {
                        addName(question.name.slice(0, -2));
                    }
                }

                if (questionKey) {
                    addName(questionKey);
                    if (questionKey.slice(-2) === '[]') {
                        addName(questionKey.slice(0, -2));
                    }
                }

                if (questionKey && Object.prototype.hasOwnProperty.call(questionAliasesByKey, questionKey)) {
                    var aliases = questionAliasesByKey[questionKey];
                    for (var i = 0; i < aliases.length; i++) {
                        var alias = aliases[i];
                        if (typeof alias !== 'string') {
                            continue;
                        }
                        addName(alias);
                        if (alias.slice(-2) === '[]') {
                            addName(alias.slice(0, -2));
                        }
                    }
                }

                return names;
            }

            function storeAnswerValue(identifier, value) {
                if (!identifier) {
                    return;
                }

                answerState[identifier] = value;

                var resolvedKey = null;
                if (Object.prototype.hasOwnProperty.call(questionByName, identifier)) {
                    resolvedKey = questionByName[identifier];
                } else if (Object.prototype.hasOwnProperty.call(questionNameByKey, identifier)) {
                    resolvedKey = identifier;
                }

                if (resolvedKey) {
                    if (resolvedKey !== identifier) {
                        answerState[resolvedKey] = value;
                    }

                    var canonicalName = questionNameByKey[resolvedKey];
                    if (canonicalName && canonicalName !== identifier) {
                        answerState[canonicalName] = value;
                    }

                    if (Object.prototype.hasOwnProperty.call(questionAliasesByKey, resolvedKey)) {
                        var aliasList = questionAliasesByKey[resolvedKey];
                        for (var i = 0; i < aliasList.length; i++) {
                            var aliasName = aliasList[i];
                            if (typeof aliasName !== 'string' || aliasName === identifier) {
                                continue;
                            }
                            answerState[aliasName] = value;
                        }
                    }
                }
            }

            function getStoredAnswer(questionKey, questionName) {
                if (questionKey && Object.prototype.hasOwnProperty.call(answerState, questionKey) && hasUsableValue(answerState[questionKey])) {
                    return answerState[questionKey];
                }

                if (questionName && Object.prototype.hasOwnProperty.call(answerState, questionName) && hasUsableValue(answerState[questionName])) {
                    return answerState[questionName];
                }

                if (questionKey && Object.prototype.hasOwnProperty.call(questionAliasesByKey, questionKey)) {
                    var aliases = questionAliasesByKey[questionKey];
                    for (var i = 0; i < aliases.length; i++) {
                        var alias = aliases[i];
                        if (typeof alias !== 'string') {
                            continue;
                        }

                        if (Object.prototype.hasOwnProperty.call(answerState, alias) && hasUsableValue(answerState[alias])) {
                            return answerState[alias];
                        }
                    }
                }

                return null;
            }

            var structure = parseJSON(structureScript) || {};
            var questionByName = {};
            var questionNameByKey = {};
            var questionAliasesByKey = {};

            Object.keys(structure).forEach(function (key) {
                var question = structure[key];
                if (!question) {
                    return;
                }

                var canonicalName = question.name || key;
                questionNameByKey[key] = canonicalName;

                if (canonicalName && !Object.prototype.hasOwnProperty.call(questionByName, canonicalName)) {
                    questionByName[canonicalName] = key;
                }

                if (!Object.prototype.hasOwnProperty.call(questionByName, key)) {
                    questionByName[key] = key;
                }

                if (Array.isArray(question.aliases)) {
                    questionAliasesByKey[key] = question.aliases.slice();
                    question.aliases.forEach(function (alias) {
                        if (typeof alias !== 'string') {
                            return;
                        }

                        if (!Object.prototype.hasOwnProperty.call(questionByName, alias)) {
                            questionByName[alias] = key;
                        }
                    });
                }
            });
            var dependencyScript = form.querySelector('.js-questionnaire-dependencies');
            var dependencies = dependencyScript ? parseJSON(dependencyScript) || {} : {};
            var stepsScript = form.querySelector('.js-questionnaire-steps');
            var providedSteps = stepsScript ? parseJSON(stepsScript) || {} : {};
            var storedAnswersScript = form.querySelector('.js-questionnaire-answers');
            var storedAnswers = storedAnswersScript ? parseJSON(storedAnswersScript) || {} : {};

            var currentStep = form.getAttribute('data-current-step') || '';
            var defaultStep = form.getAttribute('data-default-step') || '';
            var finalStep = form.getAttribute('data-final-step') || 'plans';
            if (!currentStep) {
                currentStep = defaultStep;
            }

            var stepQuestions = buildStepQuestions(structure, providedSteps);
            var stepOrder = buildStepOrder(stepQuestions, structure);
            var answerState = {};
            if (storedAnswers && typeof storedAnswers === 'object') {
                for (var storedKey in storedAnswers) {
                    if (Object.prototype.hasOwnProperty.call(storedAnswers, storedKey)) {
                        storeAnswerValue(storedKey, storedAnswers[storedKey]);
                    }
                }
            }

            Object.keys(structure).forEach(function (key) {
                var question = structure[key];
                if (!question) {
                    return;
                }

                var stored = getStoredAnswer(key, question.name || key);
                if (hasUsableValue(stored)) {
                    storeAnswerValue(key, stored);
                }
            });

            applyQuestionLabels(form, structure);

            Object.keys(structure).forEach(function (key) {
                var question = structure[key];
                if (!question) {
                    return;
                }

                var storedValue = getStoredAnswer(key, question.name || key);
                if (hasUsableValue(storedValue)) {
                    toggleActiveButtons(question.name || key, storedValue);
                }
            });

            form.addEventListener('change', function (event) {
                var target = event.target;
                if (!target || !target.name) {
                    return;
                }
                var updatedValue = readValueFromInput(target);
                if (target.type === 'radio') {
                    var groupSelector = '[name="' + cssEscape(target.name) + '"]:checked';
                    var activeRadio = form.querySelector(groupSelector);
                    updatedValue = activeRadio ? activeRadio.value : null;
                }
                if (target.type === 'radio' || target.type === 'checkbox') {
                    toggleActiveButtons(target.name, updatedValue);
                }
                storeAnswerValue(target.name, updatedValue);
                updateNextStep();
            }, true);

            form.addEventListener('submit', function () {
                updateNextStep();
            });

            window.submitForm = function () {
                updateNextStep();
                form.submit();
            };

            window.setValuesForm = function (questionKey, value) {
                setHiddenValue(questionKey, value);
                toggleActiveButtons(questionKey, value);
                updateNextStep();
                form.submit();
            };

            window.setValuesreorderForm = function (questionKey, value) {
                setHiddenValue(questionKey, value);
                toggleActiveButtons(questionKey, value);
                updateNextStep();
                form.submit();
            };

            updateNextStep();

            function buildStepQuestions(structure, provided) {
                if (provided && Object.keys(provided).length) {
                    return provided;
                }

                var steps = {};
                var sortedKeys = sortQuestionKeys(Object.keys(structure || {}), structure);
                sortedKeys.forEach(function (key) {
                    var question = structure[key];
                    if (!question) {
                        return;
                    }
                    var step = question.step && question.step !== '' ? question.step : key;
                    if (!steps[step]) {
                        steps[step] = [];
                    }
                    steps[step].push(key);
                });

                Object.keys(steps).forEach(function (step) {
                    steps[step] = sortQuestionKeys(steps[step], structure);
                });

                return steps;
            }

            function buildStepOrder(stepQuestions, structure) {
                var steps = stepQuestions ? Object.keys(stepQuestions) : [];
                var maxSort = (typeof Number !== 'undefined' && typeof Number.MAX_SAFE_INTEGER === 'number')
                    ? Number.MAX_SAFE_INTEGER
                    : Math.pow(2, 53) - 1;
                var originalOrder = {};

                for (var index = 0; index < steps.length; index++) {
                    originalOrder[steps[index]] = index;
                }

                function minSortForStep(stepKey) {
                    var questions = stepQuestions[stepKey] || [];
                    if (!questions.length) {
                        return maxSort;
                    }

                    var min = maxSort;
                    for (var i = 0; i < questions.length; i++) {
                        var key = questions[i];
                        var sortValue = getQuestionSort(structure[key]);
                        if (sortValue < min) {
                            min = sortValue;
                        }
                    }
                    return min;
                }

                var sortedSteps = steps.slice();
                return sortedSteps.sort(function (a, b) {
                    var sortA = minSortForStep(a);
                    var sortB = minSortForStep(b);
                    if (sortA === sortB) {
                        var originalA = Object.prototype.hasOwnProperty.call(originalOrder, a) ? originalOrder[a] : 0;
                        var originalB = Object.prototype.hasOwnProperty.call(originalOrder, b) ? originalOrder[b] : 0;
                        if (originalA === originalB) {
                            return String(a).localeCompare(String(b));
                        }
                        return originalA - originalB;
                    }
                    return sortA - sortB;
                });
            }

            function getQuestionSort(question) {
                var maxSort = (typeof Number !== 'undefined' && typeof Number.MAX_SAFE_INTEGER === 'number')
                    ? Number.MAX_SAFE_INTEGER
                    : Math.pow(2, 53) - 1;
                if (!question || typeof question.sort === 'undefined' || question.sort === null) {
                    return maxSort;
                }

                var parsed = parseInt(question.sort, 10);
                if (isNaN(parsed)) {
                    return maxSort;
                }
                return parsed;
            }

            function sortQuestionKeys(keys, structure) {
                var list = Array.isArray(keys) ? keys.slice() : [];
                return list.sort(function (a, b) {
                    var sortA = getQuestionSort(structure[a]);
                    var sortB = getQuestionSort(structure[b]);
                    if (sortA === sortB) {
                        return String(a).localeCompare(String(b));
                    }
                    return sortA - sortB;
                });
            }

            function applyQuestionLabels(form, structure) {
                Object.keys(structure).forEach(function (key) {
                    var question = structure[key];
                    var questionSlug = slugify(key);
                    var labelNodes = form.querySelectorAll('.js-question-label-' + questionSlug);
                    Array.prototype.forEach.call(labelNodes, function (node) {
                        node.textContent = question.label;
                    });

                    if (!question.options || typeof question.options !== 'object') {
                        return;
                    }

                    Object.keys(question.options).forEach(function (optionKey) {
                        var optionValue = question.options[optionKey];
                        var optionLabel = optionValue;

                        if (optionValue && typeof optionValue === 'object') {
                            if (optionValue.label) {
                                optionLabel = optionValue.label;
                            } else if (optionValue.title) {
                                optionLabel = optionValue.title;
                            } else if (optionValue.value) {
                                optionLabel = optionValue.value;
                            }
                        }

                        var value = optionKey;
                        var selectorNames = [];
                        if (question.name) {
                            selectorNames.push(question.name);
                            if (question.name.slice(-2) === '[]') {
                                selectorNames.push(question.name.slice(0, -2) + '[]');
                            }
                        }

                        selectorNames.push(key);
                        if (key.slice(-2) === '[]') {
                            selectorNames.push(key.slice(0, -2) + '[]');
                        }

                        selectorNames.forEach(function (name) {
                            var escapedName = cssEscape(name);
                            var escapedValue = cssEscape(value);
                            var inputs = form.querySelectorAll('input[name="' + escapedName + '"][value="' + escapedValue + '"]');
                            Array.prototype.forEach.call(inputs, function (input) {
                                var target = null;

                                if (input.id) {
                                    target = form.querySelector('label[for="' + cssEscape(input.id) + '"]');
                                }

                                if (!target && input.parentElement) {
                                    target = input.parentElement.querySelector('label');
                                }

                                if (!target && input.parentElement) {
                                    target = input.parentElement.querySelector('.box_text');
                                }

                                if (!target && input.nextElementSibling && input.nextElementSibling.tagName === 'SPAN') {
                                    target = input.nextElementSibling;
                                }

                                if (target) {
                                    target.textContent = optionLabel;
                                }
                            });
                        });

                        var optionSlug = slugify(optionKey);
                        var buttonTargets = form.querySelectorAll('[data-question-option-key="' + questionSlug + '"][data-question-option-value="' + optionSlug + '"]');
                        Array.prototype.forEach.call(buttonTargets, function (node) {
                            node.textContent = optionLabel;
                        });
                    });
                });
            }

            function updateNextStep() {
                var fields = form.querySelectorAll('input[name="nextstep"]');
                if (!fields.length) {
                    return;
                }
                var next = computeNextStep();
                Array.prototype.forEach.call(fields, function (field) {
                    field.value = next || '';
                });
            }

            function computeNextStep() {
                var step = currentStep || stepOrder[0] || '';
                if (!step) {
                    return '';
                }

                var questions = stepQuestions[step] || [];
                for (var i = 0; i < questions.length; i++) {
                    var key = questions[i];
                    var question = structure[key];
                    if (!question) {
                        continue;
                    }
                    var value = readAnswer(question, key);
                    if (value === null || typeof value === 'undefined' || (Array.isArray(value) && !value.length)) {
                        continue;
                    }

                    var dependencyNext = dependencyRouting(question, value);
                    if (dependencyNext) {
                        return dependencyNext;
                    }
                }

                var index = stepOrder.indexOf(step);
                if (index !== -1 && index + 1 < stepOrder.length) {
                    return stepOrder[index + 1];
                }

                return finalStep;
            }

            function dependencyRouting(question, value) {
                var key = question.key || question.name;
                if (!key) {
                    return null;
                }

                var questionDependencies = dependencies[key];
                if (!questionDependencies || !questionDependencies.length) {
                    return null;
                }

                var values = Array.isArray(value) ? value : [value];
                var normalizedValues = normalizeValues(values);

                for (var i = 0; i < questionDependencies.length; i++) {
                    var dependency = questionDependencies[i];
                    if (!dependency) {
                        continue;
                    }

                    var dependencyValues = typeof dependency.values === 'undefined' ? null : dependency.values;
                    if (dependencyValues === null) {
                        continue;
                    }

                    var targetStep = dependency.step;
                    if (!targetStep && dependency.question) {
                        var dependencyQuestion = structure[dependency.question];
                        if (dependencyQuestion && dependencyQuestion.step) {
                            targetStep = dependencyQuestion.step;
                        } else {
                            targetStep = dependency.question;
                        }
                    }

                    if (!targetStep) {
                        continue;
                    }

                    var normalizedDependencyValues = normalizeValues(dependencyValues);
                    if (hasIntersection(normalizedValues, normalizedDependencyValues)) {
                        return targetStep;
                    }
                }

                return null;
            }

            function readAnswer(question, questionKey) {
                var key = questionKey || (question && question.key) || null;
                var name = question && question.name ? question.name : key;
                var storedValue = getStoredAnswer(key, name);

                if (hasUsableValue(storedValue)) {
                    return storedValue;
                }

                var selectorNames = collectSelectorNames(key, question);

                if (question && question.type === 'checkbox') {
                    for (var i = 0; i < selectorNames.length; i++) {
                        var checkboxName = selectorNames[i];
                        var nodes = form.querySelectorAll('[name="' + cssEscape(checkboxName) + '"]');
                        if (!nodes.length) {
                            continue;
                        }
                        var values = [];
                        Array.prototype.forEach.call(nodes, function (node) {
                            if (node.checked) {
                                values.push(node.value);
                            }
                        });
                        if (values.length) {
                            storeAnswerValue(checkboxName, values);
                            return values;
                        }
                    }
                    return [];
                }

                if (question && question.type === 'radio') {
                    for (var j = 0; j < selectorNames.length; j++) {
                        var radioName = selectorNames[j];
                        var checked = form.querySelector('[name="' + cssEscape(radioName) + '"]:checked');
                        if (checked && hasUsableValue(checked.value)) {
                            storeAnswerValue(radioName, checked.value);
                            return checked.value;
                        }
                    }
                    return null;
                }

                for (var k = 0; k < selectorNames.length; k++) {
                    var input = form.querySelector('[name="' + cssEscape(selectorNames[k]) + '"]');
                    if (input) {
                        var inputValue = input.value;
                        if (hasUsableValue(inputValue)) {
                            storeAnswerValue(selectorNames[k], inputValue);
                            return inputValue;
                        }
                    }
                }

                var idCandidates = [];
                if (key) {
                    idCandidates.push(key);
                }
                if (name && idCandidates.indexOf(name) === -1) {
                    idCandidates.push(name);
                }

                for (var index = 0; index < idCandidates.length; index++) {
                    var element = document.getElementById(idCandidates[index]);
                    if (!element) {
                        continue;
                    }

                    if (question && question.type === 'checkbox') {
                        if (element.checked) {
                            storeAnswerValue(idCandidates[index], [element.value]);
                            return [element.value];
                        }
                        continue;
                    }

                    if (question && question.type === 'radio') {
                        if (element.checked && hasUsableValue(element.value)) {
                            storeAnswerValue(idCandidates[index], element.value);
                            return element.value;
                        }
                        continue;
                    }

                    if (hasUsableValue(element.value)) {
                        storeAnswerValue(idCandidates[index], element.value);
                        return element.value;
                    }
                }

                return null;
            }

            function setHiddenValue(questionKey, value) {
                var field = document.getElementById(questionKey);
                if (!field) {
                    field = form.querySelector('[name="' + cssEscape(questionKey) + '"]');
                }
                if (!field) {
                    field = form.querySelector('[name="' + cssEscape(questionKey) + '[]"]');
                }
                if (!field && Object.prototype.hasOwnProperty.call(questionByName, questionKey)) {
                    var resolvedKey = questionByName[questionKey];
                    if (resolvedKey && resolvedKey !== questionKey) {
                        field = document.getElementById(resolvedKey);
                        if (!field) {
                            field = form.querySelector('[name="' + cssEscape(resolvedKey) + '"]');
                        }
                        if (!field) {
                            field = form.querySelector('[name="' + cssEscape(resolvedKey) + '[]"]');
                        }
                    }
                }
                if (!field) {
                    return;
                }

                if (field.type === 'checkbox') {
                    var values = Array.isArray(value) ? value : [value];
                    var checkboxName = field.name || questionKey;
                    var nodes = form.querySelectorAll('[name="' + cssEscape(checkboxName) + '"]');
                    Array.prototype.forEach.call(nodes, function (node) {
                        node.checked = values.indexOf(node.value) !== -1;
                    });
                } else {
                    field.value = value;
                }

                storeAnswerValue(questionKey, value);
                if (field.name && field.name !== questionKey) {
                    storeAnswerValue(field.name, value);
                }
            }

            function toggleActiveButtons(questionKey, value) {
                if (!questionKey) {
                    return;
                }
                var slug = slugify(questionKey);
                var nodes = form.querySelectorAll('[data-question-option-key="' + slug + '"]');
                if (!nodes.length) {
                    return;
                }

                var values = Array.isArray(value) ? value.map(String) : [String(value)];
                Array.prototype.forEach.call(nodes, function (node) {
                    var parentButton = node.closest('button');
                    if (!parentButton) {
                        return;
                    }
                    var optionValue = node.getAttribute('data-question-option-value');
                    if (optionValue && values.indexOf(optionValue) !== -1) {
                        parentButton.classList.add('active');
                    } else {
                        parentButton.classList.remove('active');
                    }
                });
            }

            function readValueFromInput(input) {
                if (input.type === 'checkbox') {
                    var values = [];
                    var nodes = form.querySelectorAll('[name="' + cssEscape(input.name) + '"]');
                    Array.prototype.forEach.call(nodes, function (node) {
                        if (node.checked) {
                            values.push(node.value);
                        }
                    });
                    return values;
                }
                if (input.type === 'radio') {
                    return input.checked ? input.value : null;
                }
                return input.value;
            }
        })();
    </script>
</perch:form>
